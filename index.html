<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <meta name="naver-site-verification" content="a8106e0cbefd36468e543556b1a32d52aa11f6a6" />
  <title>Key Therapy - 온라인 타자연습 & 게임</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&family=Poppins:wght@400;500;600;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
.shake-effect {
  animation: shake 0.2s;
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}
.flash-effect {
  animation: flash 0.3s ease-out;
}
@keyframes flash {
  0%, 100% { box-shadow: none; border-color: var(--input-border); }
  50% {
    box-shadow: 0 0 15px 5px rgba(255, 82, 82, 0.7);
    border-color: rgba(255, 82, 82, 0.9);
  }
}
    :root {
      --bg-main: #201e1c;
      --bg-container: #2a2826;
      --bg-typing-area: #262422;
      --bg-progress-bar: var(--accent-secondary);
      --bg-progress-bar-track: #44403d;
      --text-primary: #e8e0d8;
      --text-secondary: #b2aca2;
      --accent-primary: #d4af7a;
      --accent-secondary: #c8a273;
      --accent-active: #b89263;
      --accent-darker: #aa8a5a;
      --highlight-error: #f48fb1;
      --highlight-error-bg: rgba(244, 143, 177, 0.1);
      --input-bg: #33302e;
      --input-text: #f5f0eb;
      --input-border: #4a4643;
      --input-focus-shadow: 0 0 10px rgba(var(--accent-rgb), 0.45);
      --button-text: #2f2c2a;
      --button-text-on-accent: #332e2a;
      --current-line-bg: rgba(var(--accent-rgb), 0.08);
      --current-line-text: var(--text-primary);
      --current-line-typed-text: var(--accent-primary);
      --current-line-border: rgba(var(--accent-rgb), 0.35);
      --current-line-shadow: 0 2px 12px rgba(var(--accent-rgb),0.12);
      --font-body: 'Noto Sans KR', sans-serif;
      --font-heading: 'Playfair Display', serif;
      --font-typing: 'Nanum Myeongjo', 'Courier New', monospace;
      --font-ui: 'Poppins', sans-serif;
      --line-height-typing: 1.8;
      --font-size-typing: 1.15rem;
      --font-size-typing-mobile: 1.05rem;
      --accent-rgb: 212, 175, 122;
      --accent-primary-rgb: 212, 175, 122;
      --hero-image-url: url('https://images.unsplash.com/photo-1505322265381-3138d62ub20a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTJ8fGtleWJvYXJkJTIwYWVzdGhldGljfGVufDB8fDB8fHww&auto=format&fit=crop&w=1000&q=80');
      --typing-letter-spacing: 0.8px;
      --typing-word-spacing: 2px;
      --typing-letter-spacing-mobile: 0.5px;
      --typing-word-spacing-mobile: 1.5px;
      --border-radius-main: 12px;
      --border-radius-small: 8px;
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.4);
      --shadow-inset: inset 0 2px 5px rgba(0,0,0,0.25);
      --shadow-button: 0 5px 12px rgba(0,0,0,0.28);
      --shadow-button-hover: 0 7px 15px rgba(0,0,0,0.32);
    }
    .light-theme {
      --bg-main: #fdfaf6;
      --bg-container: #fff;
      --bg-typing-area: #f9f5f0;
      --bg-progress-bar: #c0a580;
      --bg-progress-bar-track: #ede7de;
      --text-primary: #524a42;
      --text-secondary: #756A5F;
      --accent-primary: #b89a6c;
      --accent-secondary: #c8ad82;
      --accent-active: #a88a5c;
      --accent-darker: #987b4f;
      --accent-rgb: 184, 154, 108;
      --accent-primary-rgb: 184, 154, 108;
      --input-bg: #fefcf9;
      --input-text: #4a4037;
      --input-border: #dcd3c9;
      --input-focus-shadow: 0 0 8px rgba(var(--accent-rgb), 0.25);
      --button-text: #4a4037;
      --button-text-on-accent: #fefcf9;
      --current-line-bg: rgba(var(--accent-rgb), 0.06);
      --current-line-text: #504840;
      --current-line-typed-text: var(--accent-active);
      --current-line-border: rgba(var(--accent-rgb), 0.25);
      --current-line-shadow: 0 2px 8px rgba(var(--accent-rgb),0.1);
      --highlight-error: #d3546d;
      --highlight-error-bg: rgba(211, 84, 109, 0.07);
      --shadow-soft: 0 6px 20px rgba(170, 150, 130, 0.08);
      --shadow-inset: inset 0 1px 2px rgba(0,0,0,0.025);
      --shadow-button: 0 3px 8px rgba(170, 150, 130, 0.07);
      --shadow-button-hover: 0 5px 12px rgba(170, 150, 130, 0.1);
    }
    .pink-theme {
      --bg-main: #fff0f5;
      --bg-container: #ffffff;
      --bg-typing-area: #fff5f8;
      --bg-progress-bar: var(--accent-secondary);
      --bg-progress-bar-track: #ffe0e9;
      --text-primary: #4F333D;
      --text-secondary: #735A64;
      --accent-primary: #E85D75;
      --accent-secondary: #F080A0;
      --accent-active: #D94F6A;
      --accent-darker: #C9405A;
      --highlight-error: #FF6347;
      --highlight-error-bg: rgba(255, 99, 71, 0.1);
      --input-bg: #fffafa;
      --input-text: #4F333D;
      --input-border: #f8d0da;
      --input-focus-shadow: 0 0 10px rgba(var(--accent-rgb), 0.35);
      --button-text: #4F333D;
      --button-text-on-accent: #ffffff;
      --current-line-bg: rgba(var(--accent-rgb), 0.1);
      --current-line-text: #4F333D;
      --current-line-typed-text: var(--accent-primary);
      --current-line-border: rgba(var(--accent-rgb), 0.3);
      --current-line-shadow: 0 2px 10px rgba(var(--accent-rgb),0.15);
      --accent-rgb: 232, 93, 117;
      --accent-primary-rgb: 232, 93, 117;
      --shadow-soft: 0 8px 25px rgba(200, 130, 150, 0.2);
      --shadow-inset: inset 0 1px 3px rgba(0,0,0,0.05);
      --shadow-button: 0 4px 10px rgba(200, 130, 150, 0.18);
      --shadow-button-hover: 0 6px 13px rgba(200, 130, 150, 0.22);
      --border-radius-main: 14px;
      --border-radius-small: 10px;
    }
    ::selection {
      background-color: var(--accent-primary);
      color: var(--button-text-on-accent);
      text-shadow: none;
    }
    .light-theme ::selection {
      background-color: var(--accent-active);
      color: var(--button-text-on-accent);
    }
    .pink-theme ::selection {
      background-color: var(--accent-active);
      color: #fff;
    }
    html { scroll-behavior: smooth; }
    body {
      background: var(--bg-main); font-family: var(--font-body); font-weight: 300;
      margin: 0; padding: 0; color: var(--text-primary); display: flex;
      flex-direction: column; min-height: 100vh; opacity: 0;
      animation: fadeInPage 0.8s 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      -webkit-tap-highlight-color: transparent;
      line-height: 1.65;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    @keyframes fadeInPage { to { opacity: 1; } }
    ::-webkit-scrollbar { width: 9px; }
    ::-webkit-scrollbar-track { background: var(--bg-typing-area); }
    ::-webkit-scrollbar-thumb { background: var(--accent-secondary); border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }
    .main-content-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        flex-grow: 1;
        padding: 25px 15px;
        width: 100%; box-sizing: border-box;
    }
    .main-content {
      max-width: 1000px;
      width: 100%; background-color: var(--bg-container);
      border-radius: var(--border-radius-main); box-shadow: var(--shadow-soft);
      display: flex; flex-direction: column; overflow: hidden;
      border: 1px solid rgba(var(--accent-primary-rgb), 0.1);
      transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, border-radius 0.3s ease, max-width 0.4s ease-in-out;
    }
    .light-theme .main-content { border-color: rgba(var(--accent-rgb), 0.18); }
    .pink-theme .main-content { border-color: rgba(var(--accent-rgb), 0.25); }
    body.game-mode-active .hero-section,
    body.game-mode-active .controls-and-stats-wrapper .practice-mode-controls,
    body.game-mode-active .controls-and-stats-wrapper .feature-toggles,
    body.game-mode-active .controls-and-stats-wrapper #stats,
    body.game-mode-active .progress-bar-container,
    body.game-mode-active .typing-area-container,
    body.game-mode-active #result,
    body.game-mode-active .footer {
        display: none !important;
    }
    body.game-mode-active .controls-and-stats-wrapper { padding-bottom: 0; }
    body.game-mode-active .settings-container { margin-bottom: 0; }
    body.game-mode-active .main-controls { justify-content: center; gap: 15px; }
    body.game-mode-active .sound-settings,
    body.game-mode-active .theme-settings { display: flex !important; margin-left: 0; }
    body.game-mode-active .main-content-wrapper { align-items: center; padding: 15px; }
    body.game-mode-active .main-content { max-width: 1200px; min-height: 85vh; }
    body.game-mode-active #game-area-container {
        display: flex !important;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        flex-grow: 1;
        width: 100%;
        padding: 0;
        box-sizing: border-box;
        position: relative;
    }
    .hero-section {
      width: 100%; padding: 35px 25px;
      background-image:
        linear-gradient(to bottom, rgba(var(--bg-container-rgb, 42, 40, 38), 0.2) 0%, rgba(var(--bg-container-rgb, 42, 40, 38), 0.9) 100%),
        var(--hero-image-url);
      background-size: cover; background-position: center 25%;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      text-align: center; position: relative; border-radius: var(--border-radius-main) var(--border-radius-main) 0 0;
      box-sizing: border-box; border-bottom: 1px solid rgba(var(--accent-primary-rgb), 0.15);
      transition: border-radius 0.3s ease;
    }
    .light-theme .hero-section {
        background-image:
            linear-gradient(to bottom, rgba(var(--accent-rgb),0.02) 0%, rgba(var(--bg-container-rgb, 255,255,255), 0.92) 100%),
            var(--hero-image-url);
        border-bottom-color: rgba(var(--accent-rgb), 0.2);
    }
    .pink-theme .hero-section {
      background-image:
        linear-gradient(to bottom, rgba(var(--bg-container-rgb, 255,240,245),0.1) 0%, rgba(var(--bg-container-rgb, 255,245,248), 0.95) 100%),
        var(--hero-image-url);
      border-bottom-color: rgba(var(--accent-rgb), 0.25);
    }
    .hero-title {
      font-family: var(--font-heading); font-size: 2.6em;  font-weight: 700;
      color: var(--accent-primary); margin: 0 0 6px 0;
      text-shadow: 0 0 15px rgba(var(--accent-primary-rgb), 0.35), 0 2px 4px rgba(0,0,0,0.5);
      z-index: 1;
    }
    .hero-tagline {
      font-family: var(--font-body); font-size: 0.95em; font-weight: 400;
      color: var(--text-secondary); text-shadow: 0 1px 2px rgba(0,0,0,0.25);
      max-width: 80%; margin-left: auto; margin-right: auto;
    }
    .light-theme .hero-title, .pink-theme .hero-title { color: var(--accent-darker); }
    .light-theme .hero-title { text-shadow: 0 0 12px rgba(var(--accent-rgb),0.2), 0 1px 2px rgba(0,0,0,0.1); }
    .pink-theme .hero-title { text-shadow: 0 0 12px rgba(var(--accent-rgb),0.25), 0 1px 2px rgba(100,50,60,0.15); }
    .light-theme .hero-tagline { color: var(--text-secondary); text-shadow: 0 1px 2px rgba(0,0,0,0.08); }
    .pink-theme .hero-tagline { color: var(--text-secondary); text-shadow: 0 1px 2px rgba(100,50,60,0.1); }
    .controls-and-stats-wrapper { padding: 25px 25px 15px; }
    .settings-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 18px; }
    .main-controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 12px; }
    .control-button-group { display: flex; flex-wrap: wrap; gap: 10px; }
    .control-button-group button {
      padding: 10px 15px; font-size: 0.9em; border-radius: var(--border-radius-small);
      cursor: pointer; transition: all 0.2s ease-in-out;
      font-family: var(--font-ui); font-weight: 500; letter-spacing: 0.25px;
      outline: none; flex-grow: 1; display: inline-flex; align-items: center; justify-content: center;
      border: 1.5px solid var(--accent-secondary); background: transparent;
      color: var(--accent-secondary); text-shadow: none; box-shadow: none;
    }
    .control-button-group button:hover {
      background: var(--accent-secondary); color: var(--button-text-on-accent);
      border-color: var(--accent-secondary); transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(var(--accent-rgb),0.15);
    }
    .control-button-group button.active {
      background: var(--accent-primary); color: var(--button-text-on-accent);
      border-color: var(--accent-primary); font-weight: 600;
      box-shadow: 0 1px 4px rgba(var(--accent-rgb),0.2), inset 0 1px 1px rgba(0,0,0,0.05);
      transform: translateY(0);
    }
    .control-button-group button.active:hover { background: var(--accent-active); border-color: var(--accent-active); }
    .control-button-group button i { margin-right: 7px; opacity: 0.75; font-size: 0.95em; line-height: 1; }
    .control-button-group button.active i { opacity: 1; }
    .light-theme .control-button-group button, .pink-theme .control-button-group button { border-color: var(--accent-secondary); color: var(--accent-secondary); }
    .light-theme .control-button-group button:hover, .pink-theme .control-button-group button:hover {
        background: var(--accent-secondary); color: var(--button-text-on-accent);
        border-color: var(--accent-secondary); box-shadow: var(--shadow-button-hover);
    }
    .light-theme .control-button-group button.active, .pink-theme .control-button-group button.active {
        background: var(--accent-primary); color: var(--button-text-on-accent);
        border-color: var(--accent-primary); box-shadow: var(--shadow-button), inset 0 1px 1px rgba(0,0,0,0.03);
    }
    .light-theme .control-button-group button.active:hover, .pink-theme .control-button-group button.active:hover { background: var(--accent-active); border-color: var(--accent-active); }
    .practice-mode-controls { composes: control-button-group; flex-basis: 100%; order: 1; }
    .practice-mode-controls button { min-width: 100px; }
    .feature-toggles { composes: control-button-group; gap: 10px; justify-content: flex-start; order: 2; flex-grow: 1; }
    .feature-toggles button { border-radius: 20px; min-width: 120px; }
    .sound-settings, .theme-settings { display: flex; align-items: center; gap: 8px; order: 3; flex-shrink: 0; }
    .select-label { font-size: 0.9em; color: var(--text-secondary); font-weight: 400; }
    #soundPackSelect, #themeSelect, #gameLangSelect, #gameLevelSelect {
        background-color: var(--input-bg); color: var(--input-text);
        border: 1px solid var(--input-border); border-radius: var(--border-radius-small);
        padding: 9px 12px; font-family: var(--font-ui); font-size: 0.9em;
        outline: none; min-width: 120px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease, border-radius 0.3s ease;
        box-shadow: var(--shadow-inset);
    }
    #soundPackSelect:focus, #themeSelect:focus, #gameLangSelect:focus, #gameLevelSelect:focus {
         border-color: var(--accent-active); box-shadow: var(--input-focus-shadow), var(--shadow-inset);
    }
    #stats {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 10px; margin-bottom: 18px; padding: 15px 18px;
      background-color: rgba(var(--accent-rgb), 0.03);
      border-radius: var(--border-radius-small); font-size: 0.92em; color: var(--text-secondary);
      border: 1px solid rgba(var(--accent-rgb), 0.1); box-shadow: var(--shadow-inset);
      transition: opacity 0.3s ease, max-height 0.4s ease, margin-bottom 0.4s ease, padding 0.4s ease, visibility 0.4s ease, border-width 0.4s ease, border-radius 0.3s ease;
      max-height: 200px; overflow: hidden;
    }
    #stats.hidden {
        opacity: 0; max-height: 0; padding-top: 0; padding-bottom: 0;
        margin-bottom: 0; border-width: 0; visibility: hidden;
    }
    .light-theme #stats { background-color: rgba(var(--accent-rgb), 0.05); border-color: rgba(var(--accent-rgb), 0.12); }
    .pink-theme #stats { background-color: rgba(var(--accent-rgb), 0.06); border-color: rgba(var(--accent-rgb), 0.15); }
    #stats span { text-align: center; padding: 8px 5px; }
    #stats .label {
        color: var(--text-secondary); font-weight: 500; display: block;
        margin-bottom: 6px; font-size: 0.88em; text-transform: uppercase; letter-spacing: 0.5px;
    }
    #stats .value { color: var(--accent-primary); font-weight: 600; font-size: 1.2em; font-family: var(--font-ui); line-height: 1.1; }
    .light-theme #stats .value, .pink-theme #stats .value { color: var(--accent-darker); }
    .progress-bar-container {
        width: 100%; max-width: 700px; height: 5px;
        background-color: var(--bg-progress-bar-track);
        border-radius: 2.5px; margin: 8px auto 12px;
        overflow: hidden; display: none;
    }
    .progress-bar {
        height: 100%; width: 0%;
        background-color: var(--bg-progress-bar);
        border-radius: 2.5px; transition: width 0.25s ease-out;
    }
    .typing-area-container {
        padding: 20px 25px 28px; background-color: var(--bg-typing-area);
        border-top: 1px solid rgba(var(--accent-primary-rgb), 0.1);
        flex-grow: 1; display: flex; flex-direction: column; font-family: var(--font-typing);
        font-size: var(--font-size-typing); line-height: var(--line-height-typing);
        border-radius: 0 0 var(--border-radius-main) var(--border-radius-main); min-height: 330px;
        transition: background-color 0.3s ease, border-color 0.3s ease, border-radius 0.3s ease;
    }
    .light-theme .typing-area-container { border-top-color: rgba(var(--accent-rgb),0.15); }
    .pink-theme .typing-area-container { border-top-color: rgba(var(--accent-rgb),0.2); }
    #line-display-area {
        display: flex; flex-direction: column; align-items: center;
        margin-bottom: 0px; width: 100%;
        min-height: calc((var(--font-size-typing) * var(--line-height-typing) + 8px) * 2);
    }
    .typing-line, #typing-input-field {
        width: 100%; max-width: 700px; padding: 12px 16px; margin: 1px auto;
        font-family: var(--font-typing); font-size: var(--font-size-typing);
        line-height: var(--line-height-typing); letter-spacing: var(--typing-letter-spacing);
        word-spacing: var(--typing-word-spacing); box-sizing: border-box;
        text-align: left; border-radius: var(--border-radius-small);
    }
    .typing-line {
        transition: opacity 0.3s ease, font-size 0.25s ease, color 0.25s ease, background-color 0.25s ease, box-shadow 0.25s ease, border-radius 0.3s ease;
        min-height: calc(var(--font-size-typing) * var(--line-height-typing) + 24px);
        display: flex; align-items: center; font-weight: 400; background-color: transparent;
    }
    .typing-line strong { font-weight: 700; color: var(--current-line-typed-text); }
    .typing-line .untyped-char { opacity: 0.7; color: var(--text-secondary); }
    .typing-line.passed, #upcoming-lines-area .typing-line {
        color: var(--text-secondary); opacity: 0.55; font-size: calc(var(--font-size-typing) * 0.92);
        background-color: transparent !important; border: none !important; box-shadow: none !important;
    }
    .light-theme .typing-line.passed, .light-theme #upcoming-lines-area .typing-line,
    .pink-theme .typing-line.passed, .pink-theme #upcoming-lines-area .typing-line { color: var(--text-secondary); opacity: 0.7; }
    .typing-line.current-to-type {
        color: var(--current-line-text); background-color: var(--current-line-bg);
        border: 1px solid var(--current-line-border); font-weight: 500; margin-bottom: 6px;
        box-shadow: var(--current-line-shadow); transform: scale(1.0);
    }
    .light-theme .typing-line.current-to-type strong, .pink-theme .typing-line.current-to-type strong { color: var(--accent-darker); }
    .light-theme .typing-line.current-to-type .untyped-char, .pink-theme .typing-line.current-to-type .untyped-char { color: var(--text-secondary); opacity: 0.85; }
    #typing-input-field-container { width: 100%; max-width: 700px; margin: 2px auto 0 auto; }
    #typing-input-field {
        background-color: var(--input-bg); color: var(--input-text);
        border: 1px solid var(--input-border); font-weight: 400;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, border-top-color 0.2s ease, border-top-style 0.2s ease, border-radius 0.3s ease;
        -webkit-appearance: none; appearance: none;
        min-height: calc(var(--font-size-typing) * var(--line-height-typing) + 24px + 2px);
        box-shadow: var(--shadow-inset); border-top: 1px solid transparent;
    }
    #typing-input-field:focus {
        border-color: var(--accent-active); border-top-color: var(--accent-active);
        box-shadow: var(--input-focus-shadow), var(--shadow-inset), 0 0 0 2px rgba(var(--accent-rgb), 0.25);
        background-color: var(--input-bg); outline: none;
    }
    .light-theme #typing-input-field:focus { box-shadow: var(--input-focus-shadow), var(--shadow-inset), 0 0 0 2px rgba(var(--accent-rgb), 0.15); }
    .pink-theme #typing-input-field:focus { box-shadow: var(--input-focus-shadow), var(--shadow-inset), 0 0 0 2px rgba(var(--accent-rgb), 0.2); }
    .highlight {
        font-weight: inherit !important; color: var(--highlight-error) !important;
        background-color: var(--highlight-error-bg);
        border-radius: 3px; padding: 0.5px 0; margin: -0.5px 0;
    }
    .light-theme .highlight { box-shadow: 0 0 4px rgba(211, 84, 109, 0.15); }
    .pink-theme .highlight { box-shadow: 0 0 4px rgba(255, 99, 71, 0.2); }
    #result {
        padding: 15px 20px; text-align: center; color: var(--accent-primary);
        font-size: 1.05em; min-height: 1.4em; font-weight: 500;
    }
    .light-theme #result, .pink-theme #result { color: var(--accent-darker); }
    .footer {
        text-align: center; padding: 25px 15px; color: var(--text-secondary);
        font-size: 0.9em; margin-top: auto; border-top: 1px solid rgba(var(--accent-primary-rgb), 0.1);
    }
    .light-theme .footer { border-top-color: rgba(var(--accent-rgb),0.15); }
    .pink-theme .footer { border-top-color: rgba(var(--accent-rgb),0.2); }
    .footer a { color: var(--accent-secondary); text-decoration: none; font-weight: 400; }
    .footer a:hover { color: var(--accent-primary); text-decoration: underline; }
    #game-area-container {
        display: none;
        background-color: var(--bg-typing-area);
        border-top: 1px solid rgba(var(--accent-primary-rgb), 0.1);
        border-radius: 0 0 var(--border-radius-main) var(--border-radius-main);
        flex-grow: 1; text-align: center; min-height: 330px;
        flex-direction: column; align-items: center;
        transition: border-radius 0.3s ease;
        width: 100%; box-sizing: border-box;
        position: relative;
    }
    .light-theme #game-area-container { border-top-color: rgba(var(--accent-rgb),0.15); }
    .pink-theme #game-area-container { border-top-color: rgba(var(--accent-rgb),0.2); }
    .game-ui-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        padding: 0 20px 20px;
        box-sizing: border-box;
        position: relative;
        flex-grow: 1;
    }
     #game-start-message {
        position: absolute;
        top: calc(50% + 20px);
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(var(--bg-container-rgb, 42, 40, 38), 0.85);
        padding: 25px;
        border-radius: var(--border-radius-small);
        text-align: center;
        z-index: 5;
        color: var(--text-primary);
        box-shadow: var(--shadow-soft);
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .light-theme #game-start-message { background-color: rgba(var(--bg-container-rgb, 255, 255, 255), 0.92); }
    .pink-theme #game-start-message { background-color: rgba(var(--bg-container-rgb, 255, 245, 248), 0.95); }
    #game-start-message h2 {
        font-family: var(--font-heading); color: var(--accent-primary);
        font-size: 1.8em; margin-bottom: 10px;
    }
    #game-start-message p {
        font-size: 1em; color: var(--text-secondary);
        line-height: 1.5; max-width: 400px; margin-bottom: 20px;
    }
    .light-theme #game-start-message h2, .pink-theme #game-start-message h2 { color: var(--accent-darker); }
    #game-canvas {
        border: 1px solid var(--input-border);
        background-color: var(--input-bg);
        border-radius: var(--border-radius-small);
        margin-bottom: 15px;
        width: 100%;
        transition: box-shadow 0.1s ease-out, border-color 0.1s ease-out;
    }
    #game-input-field {
        width: 80%; max-width: 500px; padding: 12px 15px;
        font-family: var(--font-ui); font-size: 1.1rem;
        background-color: var(--input-bg); color: var(--input-text);
        border: 1px solid var(--input-border);
        border-radius: var(--border-radius-small); box-shadow: var(--shadow-inset);
        text-align: center; outline: none;
        margin-bottom: 15px;
    }
    #game-input-field:focus {
        border-color: var(--accent-active);
        box-shadow: var(--input-focus-shadow), var(--shadow-inset);
    }
    #gameInternalControlsBar {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 10px 0;
        width: 100%;
        max-width: 700px;
    }
    .game-control-row {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 10px;
        width: 100%;
    }
    #gameInternalControlsBar .select-label { margin-right: 5px; }
    #returnToPracticeBtnGame {
        margin-top: 5px;
        padding: 10px 20px !important;
        font-size: 0.95em !important;
    }
    #gameToggleSoundBtn {
        padding: 8px 12px;
        font-size: 0.85em;
        border-radius: var(--border-radius-small);
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        font-family: var(--font-ui);
        font-weight: 500;
        border: 1.5px solid var(--accent-secondary);
        background: transparent;
        color: var(--accent-secondary);
    }
    #gameToggleSoundBtn.active {
        background: var(--accent-primary);
        color: var(--button-text-on-accent);
        border-color: var(--accent-primary);
    }
    #gameToggleSoundBtn i { margin-right: 5px;}
    .game-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(var(--bg-container-rgb, 42, 40, 38), 0.85);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        z-index: 10;
        padding: 20px;
        box-sizing: border-box;
        border-radius: var(--border-radius-main);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0s 0.3s;
    }
    .game-overlay.visible {
        opacity: 1;
        visibility: visible;
        transition: opacity 0.3s ease, visibility 0s 0s;
    }
    .light-theme .game-overlay { background-color: rgba(var(--bg-container-rgb, 255, 255, 255), 0.9); }
    .pink-theme .game-overlay { background-color: rgba(var(--bg-container-rgb, 255, 245, 248), 0.92); }
    .game-overlay h2 {
        font-family: var(--font-heading); color: var(--accent-primary);
        font-size: 2em; margin-bottom: 10px;
    }
    .game-overlay p {
        font-size: 1.1em; color: var(--text-secondary);
        line-height: 1.6; max-width: 450px; margin-bottom: 20px;
    }
    .light-theme .game-overlay h2, .pink-theme .game-overlay h2 { color: var(--accent-darker); }
    .game-button {
        padding: 12px 25px; font-size: 1em;
        border-radius: var(--border-radius-small); cursor: pointer;
        transition: all 0.2s ease-in-out; font-family: var(--font-ui);
        font-weight: 600; letter-spacing: 0.5px; outline: none;
        display: inline-flex; align-items: center; justify-content: center;
        border: 1.5px solid var(--accent-primary);
        background: var(--accent-primary); color: var(--button-text-on-accent);
        text-shadow: none; box-shadow: var(--shadow-button); margin: 10px 5px;
    }
    .game-button:hover {
        background: var(--accent-active); border-color: var(--accent-active);
        transform: translateY(-2px); box-shadow: var(--shadow-button-hover);
    }
    .game-button i { margin-right: 8px; }
    .light-theme .game-button, .pink-theme .game-button {
      background: var(--accent-primary); color: var(--button-text-on-accent);
      border-color: var(--accent-primary);
    }
    .light-theme .game-button:hover, .pink-theme .game-button:hover {
      background: var(--accent-active); border-color: var(--accent-active);
    }
    @media (max-width: 768px) {
      .hero-title { font-size: 2.2em; }
      .hero-tagline { font-size: 0.9em; max-width: 90%;}
      .main-controls { flex-direction: column; align-items: stretch; }
      body:not(.game-mode-active) .practice-mode-controls,
      body:not(.game-mode-active) .feature-toggles,
      body:not(.game-mode-active) .sound-settings,
      body:not(.game-mode-active) .theme-settings { width: 100%; justify-content: center; }
      .feature-toggles button { min-width: 100px; }
      #soundPackSelect, #themeSelect, #gameLangSelect, #gameLevelSelect { min-width: 0; width: auto; flex-grow: 1; max-width: 180px; }
      .controls-and-stats-wrapper { padding: 20px 15px 10px; }
      .typing-area-container { padding: 15px 15px 20px; min-height: 280px; }
      .typing-line, #typing-input-field { font-size: var(--font-size-typing-mobile); letter-spacing: var(--typing-letter-spacing-mobile); word-spacing: var(--typing-word-spacing-mobile); }
      #stats { grid-template-columns: repeat(2, 1fr); font-size: 0.88em; }
      #stats .value { font-size: 1.1em; }
      body.game-mode-active .main-content { min-height: 80vh; }
      .game-ui-wrapper { padding: 10px; }
      #game-start-message { top: 50%; padding: 20px; }
      #game-start-message h2 { font-size: 1.5em; }
      #game-start-message p { font-size: 0.9em; }
      .game-overlay h2 { font-size: 1.6em; }
      .game-overlay p { font-size: 1em; }
      #game-input-field { font-size: 1rem; padding: 10px; }
      .game-button { font-size: 0.9em; padding: 10px 20px; }
      #gameInternalControlsBar { gap: 8px; }
      .game-control-row { gap: 8px; flex-direction: row; align-items: center;}
      .game-control-row > * { width: auto; max-width: none; flex-grow: 0; }
      #gameToggleSoundBtn { flex-grow: 1; min-width: 120px; }
      .sound-settings, .theme-settings { flex-grow: 1; }
      .sound-settings select, .theme-settings select { width: 100%; }
      #returnToPracticeBtnGame { margin-top: 10px; }
    }
     @media (max-width: 480px) {
      .hero-title { font-size: 1.9em; }
      .hero-tagline { font-size: 0.85em; }
      .control-button-group button { font-size: 0.85em; padding: 8px 12px; }
      .feature-toggles button { min-width: 90px; }
      .select-label { font-size: 0.85em; }
      #soundPackSelect, #themeSelect, #gameLangSelect, #gameLevelSelect { font-size: 0.85em; padding: 8px 10px; }
      .typing-line, #typing-input-field { font-size: calc(var(--font-size-typing-mobile) * 0.95); }
      #stats { padding: 10px 12px; }
      #stats span { padding: 6px 4px;}
      #stats .label { font-size: 0.8em; margin-bottom: 4px; }
      #stats .value { font-size: 1em; }
      #game-start-message { padding: 15px; }
      #game-start-message h2 { font-size: 1.3em; }
      #game-start-message p { font-size: 0.85em; }
      .game-overlay h2 { font-size: 1.4em; }
      .game-overlay p { font-size: 0.9em; }
      .game-button { font-size: 0.85em; padding: 8px 15px; }
      .game-control-row { flex-direction: column; align-items: stretch; }
      #gameToggleSoundBtn { width: 100%; }
     }
</style>
</head>
<body>
  <div class="main-content-wrapper"> <div class="main-content">
    <div class="hero-section">
        <a href="https://www.youtube.com/@KeyTherapy" target="_blank" rel="noopener noreferrer" style="text-decoration: none; display: inline-block;">
            <h1 class="hero-title">Key Therapy</h1>
            <p class="hero-tagline">🎧 깊은 수면과 집중을 위한<br>키보드 타건 ASMR</p>
        </a>
    </div>
  <div class="controls-and-stats-wrapper">
    <div class="settings-container">
        <div class="main-controls">
            <div class="practice-mode-controls control-button-group">
                <button data-mode="kor"><i class="fas fa-language"></i>한글 단문</button>
                <button data-mode="korLong"><i class="fas fa-align-left"></i>한글 장문</button>
                <button data-mode="eng"><i class="fas fa-font"></i>영어 단문</button>
                <button data-mode="engLong"><i class="fas fa-stream"></i>영어 장문</button>
                <button id="gameModeBtn"><i class="fas fa-gamepad"></i>게임 모드</button>
            </div>
            <div class="feature-toggles control-button-group">
                <button id="toggleSoundBtn"><i class="fas fa-volume-mute"></i> 타건음 OFF</button>
                <button id="toggleHighlightBtn" class="active"><i class="fas fa-highlighter"></i> 오타체크 ON</button>
                <button id="toggleStatsBtn" class="active"><i class="fas fa-chart-line"></i> 측정 ON</button>
            </div>
            <div class="sound-settings" id="soundSettingsElement">
                <label for="soundPackSelect" class="select-label">타건음 선택:</label>
                <select id="soundPackSelect">
                    <option value="crunchy">서걱서걱</option>
                    <option value="pebbles">조약돌</option>
                    <option value="thocky">도각도각</option>
                </select>
            </div>
            <div class="theme-settings" id="themeSettingsElement">
                <label for="themeSelect" class="select-label">테마 선택:</label>
                <select id="themeSelect">
                    <option value="dark">다크</option>
                    <option value="light">아이보리</option>
                    <option value="pink">핑크</option>
                </select>
            </div>
        </div>
    </div>
    <div id="stats">
        <span><span class="label">속도:</span> <span id="speedStat" class="value">0 타/분</span></span>
        <span><span class="label">정확도:</span> <span id="accuracyStat" class="value">0%</span></span>
        <span><span class="label">평균:</span> <span id="avgSpeedStat" class="value">0 타/분</span></span>
        <span><span class="label">최고:</span> <span id="maxSpeedStat" class="value">0 타/분</span></span>
    </div>
</div>
<div class="progress-bar-container">
    <div class="progress-bar"></div>
</div>
<div class="typing-area-container">
    <div id="line-display-area"> </div>
    <div id="typing-input-field-container">
        <input type="text" id="typing-input-field" autocorrect="off" autocapitalize="off" spellcheck="false" autocomplete="off" inputmode="text" aria-label="타자 입력창">
    </div>
    <div id="upcoming-lines-area"> </div>
</div>
<div id="game-area-container">
</div>
<div id="result"></div>
</div>
</div>
  <div class="footer"> <p>© 2024 Key Therapy. All rights reserved. <br> Designed for focused typing practice and relaxation.</p> </div>

<script>
// === 전역 변수 및 설정 ===
let currentMode = '';
let linesToPractice = [];
let currentDisplayLineIndex = 0;

let startTime = null;
let currentLineStartTime = null;
let currentArticleCorrectChars = 0;
let lastArticleSpeed = 0;

let sessionTotalValidChars = 0;
let sessionTotalCorrectChars = 0;
let sessionTotalMistypedChars = 0;
let overallAvgSpeedLog = [];
let overallMaxSpeed = 0;
let sessionResetInProgress = false;

const KOR_SPEED_FACTOR = 2.1;
let soundEnabled = false;
let highlightEnabled = true;
let statsVisible = true;

let soundPackSelectEl, themeSelectEl, toggleStatsBtn, gameModeBtnEl;
let progressBarContainerEl, progressBarEl;
let gameAreaContainerEl, gameCanvas, gameCtx, gameInputField, gameOverlayEl, gameStartMessageEl;
let gameToggleSoundBtn;

let soundSettingsEl, themeSettingsEl;
let originalSoundParent, originalSoundNextSibling;
let originalThemeParent, originalThemeNextSibling;
let mainControlsEl;


let currentSoundPack = 'crunchy';
const soundFiles = {
    pebbles: Array.from({length: 7}, (_, i) => `soundFiles/pebbles/pebble${i + 1}.wav`),
    crunchy: Array.from({length: 11}, (_, i) => `soundFiles/crunchy/crunchy${i + 1}.wav`),
    thocky: Array.from({length: 10}, (_, i) => `soundFiles/thocky/thocky${i + 1}.wav`)
};
let audioPool = {};
const MAX_AUDIO_OBJECTS = 8;
let audioPointer = {};

let toggleHighlightBtn, lineDisplayArea, typingInputField, resultEl, upcomingLinesArea, statsEl;

// === GAME MODE VARIABLES ===
let isGameActive = false;
let gameLevel = 1;
let gameScore = 0;
let gameLives = 0;
let wordsOnScreen = [];
let gameLoopId = null;
let wordGenerationIntervalId = null;
const INITIAL_LIVES = 5;
const GAME_FONT = "18px 'Noto Sans KR', sans-serif";
let preferredGameLanguage = 'kor';
let gamePausedForOverlay = false;
let levelStartTime = null;
const LEVEL_DURATION_MS = 120 * 1000;
let isTimeStopped = false;
const ITEM_SPAWN_PROBABILITY = 0.03;

const ITEM_COLORS = {
    TIME_STOP: 'DeepSkyBlue',
    CLEAR_SCREEN: 'MediumVioletRed',
    EXTRA_LIFE: 'LawnGreen'
};

const ITEM_TYPES = {
    TIME_STOP: { type: 'timeStop', color: ITEM_COLORS.TIME_STOP, duration: 3000, textPrefix: '[멈춤!] ' },
    CLEAR_SCREEN: { type: 'clearScreen', color: ITEM_COLORS.CLEAR_SCREEN, textPrefix: '[싹쓸이!] ' },
    EXTRA_LIFE: { type: 'extraLife', color: ITEM_COLORS.EXTRA_LIFE, textPrefix: '[생명+1] ' }
};


const gameLevelsConfig = [
    { scoreToNext: 50, fallSpeed: 0.15, genRate: 6500, wordMinLenDefault: 2, wordMaxLenDefault: 2, fastWordChance: 0.01, fastWordMultiplier: 1.3 },
    { scoreToNext: 120, fallSpeed: 0.22, genRate: 5500, wordMinLenDefault: 2, wordMaxLenDefault: 3, fastWordChance: 0.02, fastWordMultiplier: 1.5 },
    { scoreToNext: 200, fallSpeed: 0.28, genRate: 5000, wordMinLenDefault: 2, wordMaxLenDefault: 4, fastWordChance: 0.03, fastWordMultiplier: 1.6 },
    { scoreToNext: 300, fallSpeed: 0.33, genRate: 4500, wordMinLenDefault: 3, wordMaxLenDefault: 4, fastWordChance: 0.04, fastWordMultiplier: 1.7 },
    { scoreToNext: 450, fallSpeed: 0.38, genRate: 4200, wordMinLenDefault: 3, wordMaxLenDefault: 5, fastWordChance: 0.05, fastWordMultiplier: 1.8 },
    { scoreToNext: 600, fallSpeed: 0.43, genRate: 4000, wordMinLenDefault: 3, wordMaxLenDefault: 5, fastWordChance: 0.06, fastWordMultiplier: 1.9 },
    { scoreToNext: 800, fallSpeed: 0.48, genRate: 3700, wordMinLenDefault: 4, wordMaxLenDefault: 6, fastWordChance: 0.07, fastWordMultiplier: 2.0 },
    { scoreToNext: 1000, fallSpeed: 0.53, genRate: 3400, wordMinLenDefault: 4, wordMaxLenDefault: 6, fastWordChance: 0.08, fastWordMultiplier: 2.1 },
    { scoreToNext: 1250, fallSpeed: 0.58, genRate: 3100, wordMinLenDefault: 4, wordMaxLenDefault: 7, fastWordChance: 0.09, fastWordMultiplier: 2.2 },
    { scoreToNext: 1500, fallSpeed: 0.63, genRate: 2900, wordMinLenDefault: 5, wordMaxLenDefault: 7, fastWordChance: 0.10, fastWordMultiplier: 2.3 },
    { scoreToNext: 1800, fallSpeed: 0.68, genRate: 2600, wordMinLenDefault: 5, wordMaxLenDefault: 8, fastWordChance: 0.11, fastWordMultiplier: 2.4 },
    { scoreToNext: 2100, fallSpeed: 0.73, genRate: 2300, wordMinLenDefault: 5, wordMaxLenDefault: 8, fastWordChance: 0.12, fastWordMultiplier: 2.5 },
    { scoreToNext: 2500, fallSpeed: 0.78, genRate: 2100, wordMinLenDefault: 6, wordMaxLenDefault: 9, fastWordChance: 0.13, fastWordMultiplier: 2.6 },
    { scoreToNext: 3000, fallSpeed: 0.85, genRate: 1900, wordMinLenDefault: 6, wordMaxLenDefault: 9, fastWordChance: 0.15, fastWordMultiplier: 2.8 },
    { scoreToNext: Infinity, fallSpeed: 1.00, genRate: 1600, wordMinLenDefault: 7, wordMaxLenDefault: 10, fastWordChance: 0.25, fastWordMultiplier: 3.2 }
];

const gameWordsKor = [
    "안녕", "하늘", "바다", "구름", "사랑", "행복", "미소", "바람", "햇살", "나무", "꽃잎", "별빛", "마음", "시간", "친구", "소망", "기억", "이유", "결심", "순간",
    "이야기", "노래", "꿈속", "추억", "선물", "감사", "희망", "용기", "믿음", "약속", "미래", "현실", "세계", "우주", "자연", "동물", "식물", "인형", "장난감",
    "과자", "사탕", "우유", "학교", "공부", "도전", "성공", "실패", "과정", "결과", "노력", "결실", "인생", "여정", "목표", "방향", "지도", "나침반", "등대",
    "게임", "놀이", "책상", "의자", "컴퓨터", "키보드", "마우스", "모니터", "프린터", "스캐너", "스피커", "헤드폰", "마이크", "카메라", "휴대폰", "태블릿",
    "음악", "영화", "여행", "사진", "그림", "조각", "건축", "디자인", "패션", "요리", "운동", "취미", "독서", "글쓰기", "토론", "발표", "강연", "세미나",
    "강아지", "고양이", "햄스터", "토끼", "새", "물고기", "거북이", "도마뱀", "뱀", "사자", "호랑이", "코끼리", "기린", "하마", "악어", "판다", "펭귄",
    "여름", "가을", "겨울", "봄날", "계절", "날씨", "온도", "습도", "바람", "태풍", "장마", "눈보라", "폭염", "한파", "미세먼지", "황사", "일기예보",
    "딸기", "포도", "수박", "사과", "바나나", "오렌지", "귤", "레몬", "자몽", "키위", "망고", "파인애플", "체리", "복숭아", "자두", "살구", "매실",
    "주스", "스무디", "에이드", "칵테일", "와인", "맥주", "소주", "막걸리", "위스키", "브랜디", "샴페인", "보드카", "데킬라", "하이볼", "막걸리",
    "비행기", "기차", "버스", "택시", "자전거", "오토바이", "지하철", "배", "요트", "크루즈", "우주선", "로켓", "드론", "행글라이더", "패러글라이딩",
    "병원", "약국", "의사", "간호사", "환자", "진료", "처방", "수술", "입원", "퇴원", "응급실", "구급차", "백신", "마스크", "소독제", "체온계",
    "공원", "산책", "등산", "캠핑", "낚시", "수영", "서핑", "스키", "스노보드", "골프", "테니스", "축구", "야구", "농구", "배구", "탁구", "배드민턴",
    "인터넷뱅킹", "스마트폰중독", "프로그래밍언어", "인공지능로봇", "가상현실체험", "블록체인기술", "데이터분석가", "클라우드컴퓨팅", "우주정거장", "심해탐사선",
    "사이버보안전문가", "머신러닝알고리즘", "자율주행자동차", "사물인터넷기기", "빅데이터플랫폼", "디지털트랜스포메이션", "지속가능한개발목표", "기후변화협약"
];
const gameWordsEng = [
    "hello", "sky", "sea", "cloud", "love", "happy", "smile", "wind", "sun", "tree", "petal", "star", "heart", "time", "friend", "wish", "dream", "hope", "idea",
    "story", "song", "memory", "gift", "thanks", "brave", "faith", "promise", "future", "world", "space", "nature", "animal", "plant", "flower", "river", "ocean",
    "snack", "candy", "milk", "school", "study", "effort", "result", "target", "vision", "policy", "market", "value", "price", "trade", "power", "energy", "force",
    "game", "play", "desk", "chair", "music", "movie", "trip", "photo", "image", "audio", "video", "chart", "graph", "table", "report", "paper", "letter",
    "apple", "grape", "melon", "pear", "berry", "juice", "water", "bread", "toast", "butter", "cheese", "yogurt", "sugar", "flour", "yeast", "honey", "syrup",
    "plane", "train", "bus", "taxi", "bike", "boat", "ship", "yacht", "truck", "ferry", "metro", "rocket", "drone", "cycle", "motor", "engine", "wheel",
    "park", "walk", "shop", "book", "code", "debug", "array", "loop", "class", "object", "method", "query", "index", "stack", "queue", "node", "link",
    "programming", "javascript", "algorithm", "database", "interface", "framework", "library", "variable", "function", "parameter", "argument", "constant", "operator",
    "developer", "engineer", "designer", "manager", "architect", "consultant", "analyst", "scientist", "professor", "student", "teacher", "mentor", "leader",
    "keyboarding", "challenge", "adventure", "mystery", "fantasy", "science", "history", "culture", "language", "education", "knowledge", "wisdom", "success"
];


function getRandom(arr) {
  if (!arr || arr.length === 0) return null;
  return arr[Math.floor(Math.random() * arr.length)];
}

const sentencePool = { kor: ["따뜻한 햇살이 창가에 가득 내린다."], eng: ["The weather is lovely today perfect for a nice walk."], korLong: [ "낡은 골목의 초입, 허리 굽은 노파의 손길이 햇살에 바래진 담벼락을 어루만진다. 그녀의 손가락 마디마디에 지난 세월의 주름이 강물처럼 새겨져 있었고, 그 마디 끝에서 스며 나온 이야기들이 무성한 담쟁이덩굴처럼 벽을 휘감았다. 담쟁이 잎사귀들은 바람에 지난날의 속삭임처럼 흔들렸고, 그 사이로 비치는 햇살은 희미한 기억의 파편들을 흩뿌렸다. 노파의 발걸음은 더 이상 빠르지 않았다. 한 걸음, 한 걸음 옮길 때마다 아스팔트 바닥에 찍히는 그림자는 더욱 길고 아득해졌다. 그녀는 문득 걸음을 멈춰 서서, 오래된 전봇대 아래 놓인 작은 벤치에 앉았다. 벤치 옆에는 누군가 심어놓은 듯한 봉숭아 꽃이 붉은 얼굴을 내밀고 있었다. 그 빛깔이 너무나 선명해서, 마치 오래된 흑백사진 속에 홀로 채색된 부분처럼 이질적이었다. 노파는 봉숭아 꽃을 한참 동안 바라보았다. 그 시선 속에는 알 수 없는 그리움과 함께, 어린 시절의 순수한 미소가 언뜻 스쳐 지나갔다. 그녀의 기억 속에는 봉숭아 꽃잎으로 손톱을 물들이며 깔깔대던 작은 소녀의 모습이 선명하게 떠올랐다. 세월은 모든 것을 앗아가지만, 어떤 기억들은 시간의 파도를 거슬러 더욱 또렷하게 남아있는 법이었다. 노파는 주머니에서 빛바랜 손수건을 꺼내 봉숭아 꽃잎을 조심스럽게 감쌌다. 그리고는 다시 천천히 발걸음을 옮겼다. 낡은 골목 끝, 그녀의 그림자가 사라지는 순간까지 담쟁이덩굴은 여전히 바람에 흔들리며, 잊혀진 시간의 노래를 부르고 있었다. 삶이란 어쩌면, 이렇듯 희미해지는 풍경 속에서 선명하게 피어나는 꽃 한 송이 같은 것인지도 모른다. 그 꽃을 가슴에 품고, 우리는 묵묵히 저물어가는 하루를 걸어간다.", "간밤의 꿈은 짙은 안개처럼 형체를 알 수 없었고, 그 희미한 잔상만이 새벽의 고요 속에 떠돈다. 현실의 차가운 공기를 마주하며 침대에서 일어선다. 동이 트기 전의 하늘은 짙은 남색을 띠고 있었고, 그 너머로 희미하게 떠오르는 여명은 마치 거대한 그림자가 서서히 물러나는 듯했다."], engLong: [ "The old attic window, streaked with the dust of ages, allowed the afternoon sun to filter in, casting a soft, golden glow over forgotten treasures. The air hung heavy with the scent of aged paper and faint wood, a nostalgic perfume that seemed to whisper tales of bygone eras. Tiny dust motes danced in the invading sunbeams, sparkling like miniature galaxies, and the world outside, viewed through the grimy pane, appeared as a distant, dreamlike watercolor. I had creaked my way up the wooden stairs, settling into the worn comfort of a rocking chair by the window. Below, an ancient oak stood sentinel, its leaves rustling a quiet, timeless song with every breeze, a silent observer of centuries unfolding. In that tranquil tableau, I found myself sifting through childhood memories: a grandmother's gentle voice narrating fairy tales, the vibrant hues of a sunset over a familiar alleyway, the first stirrings of a young heart's joy and sorrow. Time, in its relentless march, may alter all things, yet the warmth embedded in memory."]
};

document.addEventListener('DOMContentLoaded', () => {
  toggleSoundBtn = document.getElementById('toggleSoundBtn');
  toggleHighlightBtn = document.getElementById('toggleHighlightBtn');
  lineDisplayArea = document.getElementById('line-display-area');
  typingInputField = document.getElementById('typing-input-field');
  resultEl = document.getElementById('result');
  upcomingLinesArea = document.getElementById('upcoming-lines-area');
  soundPackSelectEl = document.getElementById('soundPackSelect');
  themeSelectEl = document.getElementById('themeSelect');
  toggleStatsBtn = document.getElementById('toggleStatsBtn');
  gameModeBtnEl = document.getElementById('gameModeBtn');
  progressBarContainerEl = document.querySelector('.progress-bar-container');
  progressBarEl = document.querySelector('.progress-bar');
  statsEl = document.getElementById('stats');
  gameAreaContainerEl = document.getElementById('game-area-container');

  soundSettingsEl = document.getElementById('soundSettingsElement');
  themeSettingsEl = document.getElementById('themeSettingsElement');
  mainControlsEl = document.querySelector('.main-controls');

  if (![lineDisplayArea, typingInputField, toggleSoundBtn, toggleHighlightBtn, resultEl, upcomingLinesArea, soundPackSelectEl, themeSelectEl, toggleStatsBtn, gameModeBtnEl, progressBarContainerEl, progressBarEl, statsEl, gameAreaContainerEl, soundSettingsEl, themeSettingsEl, mainControlsEl].every(el => el)) {
      console.error("하나 이상의 필수 HTML 요소를 찾을 수 없습니다.");
      if (resultEl) resultEl.textContent = "페이지 로딩 오류.";
      return;
  }

  originalSoundParent = soundSettingsEl.parentNode;
  originalSoundNextSibling = soundSettingsEl.nextSibling;
  originalThemeParent = themeSettingsEl.parentNode;
  originalThemeNextSibling = themeSettingsEl.nextSibling;

  soundPackSelectEl.value = currentSoundPack;
  const savedTheme = localStorage.getItem('typingTheme') || 'dark';
  applyTheme(savedTheme);
  themeSelectEl.value = savedTheme;

  initializeAudioPool();

  document.querySelectorAll('.practice-mode-controls button[data-mode]').forEach(button => {
    button.addEventListener('click', function() {
      if (this.id !== 'gameModeBtn') {
        startPractice(this.dataset.mode, true);
      }
    });
  });

  if (gameModeBtnEl) {
    gameModeBtnEl.addEventListener('click', activateGameMode);
  }

  toggleSoundBtn.classList.toggle('active', soundEnabled);
  toggleSoundBtn.innerHTML = soundEnabled ? '<i class="fas fa-volume-up"></i> 타건음 ON' : '<i class="fas fa-volume-mute"></i> 타건음 OFF';

  if (statsVisible) {
    toggleStatsBtn.classList.add('active');
    toggleStatsBtn.innerHTML = '<i class="fas fa-chart-line"></i> 측정 ON';
    statsEl.classList.remove('hidden');
  } else {
    toggleStatsBtn.classList.remove('active');
    toggleStatsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> 측정 OFF';
    statsEl.classList.add('hidden');
  }

  typingInputField.addEventListener('input', handleInputEvent);
  typingInputField.addEventListener('keydown', handleKeyDownEvent);

  toggleSoundBtn.addEventListener('click', () => {
    soundEnabled = !soundEnabled;
    toggleSoundBtn.classList.toggle('active', soundEnabled);
    toggleSoundBtn.innerHTML = soundEnabled ? '<i class="fas fa-volume-up"></i> 타건음 ON' : '<i class="fas fa-volume-mute"></i> 타건음 OFF';
    if (currentMode === 'game' && gameToggleSoundBtn) {
        gameToggleSoundBtn.classList.toggle('active', soundEnabled);
        gameToggleSoundBtn.innerHTML = soundEnabled ? '<i class="fas fa-volume-up"></i> 타건음 ON' : '<i class="fas fa-volume-mute"></i> 타건음 OFF';
    }
  });

  toggleHighlightBtn.addEventListener('click', () => {
    highlightEnabled = !highlightEnabled;
    toggleHighlightBtn.classList.toggle('active', highlightEnabled);
    toggleHighlightBtn.innerHTML = highlightEnabled ? '<i class="fas fa-highlighter"></i> 오타체크 ON' : '<i class="far fa-eye-slash"></i> 오타체크 OFF';
    const currentLineEl = document.getElementById('current-typing-line');
    if (currentLineEl && linesToPractice[currentDisplayLineIndex] !== undefined) {
        handleHighlightUpdate(currentLineEl, typingInputField.value, linesToPractice[currentDisplayLineIndex]);
    }
  });
  soundPackSelectEl.addEventListener('change', (event) => {
    currentSoundPack = event.target.value;
    if (audioPool[currentSoundPack] && (audioPointer[currentSoundPack] === undefined || audioPointer[currentSoundPack] === null) ) {
        audioPointer[currentSoundPack] = 0;
    } else if (!audioPool[currentSoundPack]) {
        initializeAudioPoolForPack(currentSoundPack);
    }
  });

  themeSelectEl.addEventListener('change', (event) => {
    const selectedTheme = event.target.value;
    applyTheme(selectedTheme);
    localStorage.setItem('typingTheme', selectedTheme);
  });

  toggleStatsBtn.addEventListener('click', () => {
    statsVisible = !statsVisible;
    toggleStatsBtn.classList.toggle('active', statsVisible);
    toggleStatsBtn.innerHTML = statsVisible ? '<i class="fas fa-chart-line"></i> 측정 ON' : '<i class="fas fa-eye-slash"></i> 측정 OFF';
    statsEl.classList.toggle('hidden', !statsVisible);
  });

  startPractice('kor', true);
});

function applyTheme(theme) {
    document.body.classList.remove('light-theme', 'pink-theme');
    const rootStyle = document.documentElement.style;
    rootStyle.setProperty('--border-radius-main', '12px');
    rootStyle.setProperty('--border-radius-small', '8px');

    if (theme === 'light') {
        document.body.classList.add('light-theme');
        rootStyle.setProperty('--accent-rgb', '184, 154, 108');
        rootStyle.setProperty('--accent-primary-rgb', '184, 154, 108');
        rootStyle.setProperty('--bg-container-rgb', '255, 255, 255');
    } else if (theme === 'pink') {
        document.body.classList.add('pink-theme');
        rootStyle.setProperty('--accent-rgb', '232, 93, 117');
        rootStyle.setProperty('--accent-primary-rgb', '232, 93, 117');
        rootStyle.setProperty('--bg-container-rgb', '255, 245, 248');
        rootStyle.setProperty('--border-radius-main', getComputedStyle(document.documentElement).getPropertyValue('--border-radius-main').trim() || '14px');
        rootStyle.setProperty('--border-radius-small', getComputedStyle(document.documentElement).getPropertyValue('--border-radius-small').trim() || '10px');
    } else {
        rootStyle.setProperty('--accent-rgb', '212, 175, 122');
        rootStyle.setProperty('--accent-primary-rgb', '212, 175, 122');
        rootStyle.setProperty('--bg-container-rgb', '42, 40, 38');
    }
}

function initializeAudioPoolForPack(packKey) {
    if (soundFiles.hasOwnProperty(packKey) && (!audioPool[packKey] || audioPool[packKey].length === 0)) {
        audioPool[packKey] = [];
        audioPointer[packKey] = 0;
        for (let i = 0; i < MAX_AUDIO_OBJECTS; i++) {
            const audio = new Audio();
            audio.preload = 'auto';
            audioPool[packKey].push(audio);
        }
    }
}

function initializeAudioPool() {
    for (const packKey in soundFiles) {
        initializeAudioPoolForPack(packKey);
    }
}

function startPractice(mode, resetSessionStats = false) {
    if (isGameActive) returnToPracticeMode(false);
    document.body.classList.remove('game-mode-active');
    currentMode = mode;

    if (mainControlsEl && soundSettingsEl.parentNode !== mainControlsEl) {
        originalSoundParent.insertBefore(soundSettingsEl, originalSoundNextSibling);
        originalThemeParent.insertBefore(themeSettingsEl, originalThemeNextSibling);
    }


    if (resultEl) resultEl.textContent = '새로운 문제를 불러옵니다...';
    document.querySelector('.typing-area-container').style.display = 'flex';
    if (document.getElementById('typing-input-field-container')) {
        document.getElementById('typing-input-field-container').style.display = 'block';
    }
    if (typingInputField) {
        typingInputField.disabled = false;
        typingInputField.placeholder = '';
        typingInputField.value = '';
    }
    if (gameAreaContainerEl) gameAreaContainerEl.style.display = 'none';
    if (gameStartMessageEl) gameStartMessageEl.style.display = 'none';

    document.querySelectorAll('.practice-mode-controls button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.mode === mode) btn.classList.add('active');
    });
    if (gameModeBtnEl) gameModeBtnEl.classList.remove('active');

    if (statsVisible && statsEl) statsEl.classList.remove('hidden');

    sessionResetInProgress = resetSessionStats;
    if (resetSessionStats) {
        overallMaxSpeed = 0; overallAvgSpeedLog = [];
        sessionTotalValidChars = 0; sessionTotalCorrectChars = 0; sessionTotalMistypedChars = 0;
        lastArticleSpeed = 0;
    }
    startTime = null;
    currentLineStartTime = null;
    currentArticleCorrectChars = 0;
    if (!resetSessionStats && !currentMode.includes('Long')) lastArticleSpeed = 0;

    currentDisplayLineIndex = 0;
    const poolToUse = sentencePool[currentMode];
    let textToPractice = getRandom(poolToUse);
    if (!textToPractice && poolToUse && poolToUse.length > 0) textToPractice = poolToUse[0];
    if (!textToPractice) textToPractice = "예문 로딩에 실패했습니다.";

    linesToPractice = splitTextIntoLines(textToPractice, currentMode, window.innerWidth);
    if (linesToPractice.length === 0) {
        linesToPractice.push(textToPractice.includes("실패") ? textToPractice : "예문 처리 중 오류가 발생했습니다.");
    }

    if (currentMode.includes('Long') && linesToPractice.length > 1) {
        if(progressBarContainerEl) progressBarContainerEl.style.display = 'block';
    } else {
        if(progressBarContainerEl) progressBarContainerEl.style.display = 'none';
    }

    renderTypingLayout();
    if(resultEl) resultEl.textContent = '타자를 시작하세요!';
    updateStatsDisplay(true);
    updateProgressBar();

    setTimeout(() => { if(typingInputField) typingInputField.focus(); }, 50);
    sessionResetInProgress = false;
}

function splitTextIntoLines(text, mode, screenWidth) {
    let maxLength;
    if (mode.includes('Long')) {
        if (screenWidth <= 480) maxLength = mode.includes('eng') ? 40 : 25;
        else if (screenWidth <= 768) maxLength = mode.includes('eng') ? 55 : 35;
        else maxLength = mode.includes('eng') ? 65 : 40;
    } else {
        maxLength = 1000;
    }

    const lines = [];
    if (!text || typeof text !== 'string') return [""];
    if (maxLength === 1000 || !mode.includes('Long')) {
        lines.push(text.trim());
    } else {
        let currentLine = "";
        const words = text.split(/(\s+)/);
        for (const word of words) {
            if (currentLine.length > 0 && currentLine.length + word.trim().length > maxLength && !/^\s+$/.test(word)) {
                lines.push(currentLine.trim());
                currentLine = "";
            }
            currentLine += word;
        }
        if (currentLine.trim().length > 0) lines.push(currentLine.trim());
    }
    return lines.length > 0 ? lines : [text.trim()];
}

function renderTypingLayout() {
    if (!lineDisplayArea || !upcomingLinesArea) return;
    lineDisplayArea.innerHTML = ''; upcomingLinesArea.innerHTML = '';
    const fragmentPassedCurrent = document.createDocumentFragment();
    const fragmentUpcoming = document.createDocumentFragment();

    const passedLineText = (currentDisplayLineIndex > 0 && linesToPractice[currentDisplayLineIndex - 1] !== undefined) ? linesToPractice[currentDisplayLineIndex - 1] : " ";
    const passedEl = document.createElement('div');
    passedEl.classList.add('typing-line', 'passed');
    passedEl.innerHTML = passedLineText.replace(/ /g, ' ');
    if (passedLineText === " ") passedEl.style.visibility = 'hidden';
    fragmentPassedCurrent.appendChild(passedEl);

    const currentLineText = (currentDisplayLineIndex < linesToPractice.length) ? linesToPractice[currentDisplayLineIndex] : "";
    const currentEl = document.createElement('div');
    currentEl.id = 'current-typing-line';
    currentEl.classList.add('typing-line');

    if (currentLineText !== null && currentLineText !== undefined && currentLineText.length > 0) {
        currentEl.classList.add('current-to-type');
        currentEl.dataset.originalLine = currentLineText;
        handleHighlightUpdate(currentEl, "", currentLineText);
    } else {
        currentEl.innerHTML = ' ';
        currentEl.style.boxShadow = 'none';
        currentEl.style.backgroundColor = 'transparent';
        currentEl.style.border = '1px solid transparent';
    }
    fragmentPassedCurrent.appendChild(currentEl);
    lineDisplayArea.appendChild(fragmentPassedCurrent);

    for (let i = 1; i <= MAX_VISIBLE_UPCOMING_LINES; i++) {
        const upcomingIndex = currentDisplayLineIndex + i;
        const upcomingLineText = (upcomingIndex < linesToPractice.length && linesToPractice[upcomingIndex] !== undefined) ? linesToPractice[upcomingIndex] : " ";
        const upcomingEl = document.createElement('div');
        upcomingEl.classList.add('typing-line', 'upcoming');
        upcomingEl.innerHTML = upcomingLineText.replace(/ /g, ' ');
        if (upcomingLineText === " ") upcomingEl.style.visibility = 'hidden';
        fragmentUpcoming.appendChild(upcomingEl);
    }
    upcomingLinesArea.appendChild(fragmentUpcoming);
}

function handleInputEvent() {
    if (currentMode === 'game' || isGameActive) return;

    const typedValue = typingInputField.value;
    const currentLineEl = document.getElementById('current-typing-line');
    if (!currentLineEl) return;
    const originalLine = linesToPractice[currentDisplayLineIndex] || "";

    playTypingSound();

    if (typedValue.length > 0) {
        if (!startTime) startTime = Date.now();
        if (originalLine && !currentLineStartTime) currentLineStartTime = Date.now();
        if (startTime) updateStatsDisplay(false);
    } else if (startTime && typedValue.length === 0) {
        updateStatsDisplay(false);
    }
    handleHighlightUpdate(currentLineEl, typedValue, originalLine);
}

function handleHighlightUpdate(targetElement, typedValue, originalLine) {
    if (!targetElement) return;
    if (typeof originalLine !== 'string') { targetElement.innerHTML = ' '; return; }
    let formattedOriginalHTML = '';
    for (let i = 0; i < originalLine.length; i++) {
        const char = originalLine[i] === ' ' ? ' ' : originalLine[i];
        if (i < typedValue.length) {
            if (highlightEnabled && typedValue[i] !== originalLine[i]) {
                formattedOriginalHTML += `<span class="highlight">${char}</span>`;
            } else formattedOriginalHTML += `<strong>${char}</strong>`;
        } else formattedOriginalHTML += `<span class="untyped-char">${char}</span>`;
    }
    targetElement.innerHTML = formattedOriginalHTML || ' ';
}

function handleKeyDownEvent(e) {
    if (currentMode === 'game' || isGameActive) {
      if (e.key === 'Enter') e.preventDefault();
      return;
    }
    const typedValue = typingInputField.value;
    const originalLine = (currentDisplayLineIndex < linesToPractice.length) ? linesToPractice[currentDisplayLineIndex] : null;

    if (e.key === 'Backspace' || (e.key === 'Shift' && !e.repeat && !e.altKey && !e.ctrlKey && !e.metaKey) ) {
        playTypingSound();
    }
    const isModifierKey = e.ctrlKey || e.altKey || e.metaKey;
    if (e.key.length === 1 && !isModifierKey) {
        if (!startTime) startTime = Date.now();
        if (originalLine && !currentLineStartTime) currentLineStartTime = Date.now();
        updateStatsDisplay(false);
    }
    if (e.key === 'Enter') {
        e.preventDefault();
        if (originalLine !== null && originalLine !== undefined) processCurrentLineCompletion();
        else if (currentDisplayLineIndex >= linesToPractice.length) startPractice(currentMode, false);
    } else if (e.key === ' ' && originalLine !== null && typedValue.length >= originalLine.length) {
        e.preventDefault();
        processCurrentLineCompletion();
    }
}

function processCurrentLineCompletion() {
    const typedValue = typingInputField.value;
    if (currentDisplayLineIndex >= linesToPractice.length) {
        startPractice(currentMode, false); return;
    }
    const originalLine = linesToPractice[currentDisplayLineIndex];
    if (originalLine === null || originalLine === undefined) {
        currentDisplayLineIndex++;
        if (currentDisplayLineIndex < linesToPractice.length) renderTypingLayout();
        else startPractice(currentMode, false);
        return;
    }

    let lineCorrectCharsThisLine = 0;
    let lineMistypedCharsOnThisLine = 0;
    for (let i = 0; i < originalLine.length; i++) {
        if (i < typedValue.length) {
            if (typedValue[i] === originalLine[i]) lineCorrectCharsThisLine++;
            else lineMistypedCharsOnThisLine++;
        } else lineMistypedCharsOnThisLine++;
    }
    if (typedValue.length > originalLine.length) lineMistypedCharsOnThisLine += (typedValue.length - originalLine.length);

    currentArticleCorrectChars += lineCorrectCharsThisLine;
    sessionTotalCorrectChars += lineCorrectCharsThisLine;
    sessionTotalMistypedChars += lineMistypedCharsOnThisLine;
    sessionTotalValidChars += originalLine.length;

    if (currentLineStartTime && lineCorrectCharsThisLine > 0) {
        const elapsedLineMinutes = (Date.now() - currentLineStartTime) / 60000;
        if (elapsedLineMinutes > 0.0001) {
            lastArticleSpeed = Math.round((lineCorrectCharsThisLine / elapsedLineMinutes) * (currentMode.includes('kor') ? KOR_SPEED_FACTOR : 1));
        } else {
            lastArticleSpeed = Math.round((lineCorrectCharsThisLine / 0.0001) * (currentMode.includes('kor') ? KOR_SPEED_FACTOR : 1) / 60 );
        }
        if (lastArticleSpeed > 0 && lastArticleSpeed < 5000) {
            overallAvgSpeedLog.push(lastArticleSpeed);
            if (lastArticleSpeed > overallMaxSpeed) overallMaxSpeed = lastArticleSpeed;
        }
    } else if (lineCorrectCharsThisLine === 0 && originalLine.length > 0) {
        lastArticleSpeed = 0;
         if (overallAvgSpeedLog.length > 0 || lastArticleSpeed === 0) overallAvgSpeedLog.push(0);
    }

    currentDisplayLineIndex++;
    if(typingInputField) typingInputField.value = '';
    currentLineStartTime = null;

    if (!currentMode.includes('Long')) {
        currentArticleCorrectChars = 0; startTime = null;
    }

    if (currentDisplayLineIndex < linesToPractice.length) {
        renderTypingLayout();
        if(resultEl) resultEl.textContent = currentMode.includes('Long') ? '다음 줄...' : '다음 문제!';
        updateStatsDisplay(false); updateProgressBar();
        setTimeout(() => { if(typingInputField) typingInputField.focus(); }, 50);
    } else {
        updateStatsDisplay(false); updateProgressBar();
        if(resultEl) resultEl.textContent = currentMode.includes('Long') ? '장문 완료! 새로운 문제 준비 중...' : '연습 완료! 새로운 문제 준비 중...';
        if (currentMode.includes('Long')) {
            currentArticleCorrectChars = 0; startTime = null;
        }
        setTimeout(() => startPractice(currentMode, false), 800);
    }
}

function updateStatsDisplay(isNewArticleOrSessionReset = false) {
  const statsElements = {
    speed: document.getElementById('speedStat'), accuracy: document.getElementById('accuracyStat'),
    avg: document.getElementById('avgSpeedStat'), max: document.getElementById('maxSpeedStat')
  };
  if (!Object.values(statsElements).every(el => el)) return;

  let currentSpeedToShow = 0;
  if (sessionResetInProgress || (isNewArticleOrSessionReset && startTime === null)) currentSpeedToShow = 0;
  else if (currentMode.includes('Long') && startTime && currentArticleCorrectChars > 0) {
      const elapsedMinutes = (Date.now() - startTime) / 60000;
      if (elapsedMinutes > 0.0001) currentSpeedToShow = Math.round((currentArticleCorrectChars / elapsedMinutes) * (currentMode.includes('kor') ? KOR_SPEED_FACTOR : 1));
  } else currentSpeedToShow = lastArticleSpeed;
  statsElements.speed.textContent = `${currentSpeedToShow} 타/분`;

  let accuracy = 0;
  if (sessionResetInProgress) accuracy = 0;
  else if (sessionTotalValidChars > 0) accuracy = Math.max(0, Math.min(Math.round((sessionTotalCorrectChars / sessionTotalValidChars) * 100), 100));
  statsElements.accuracy.textContent = `${accuracy}%`;

  let finalOverallAverageSpeed = 0;
  if (sessionResetInProgress) finalOverallAverageSpeed = 0;
  else if (overallAvgSpeedLog.length > 0) finalOverallAverageSpeed = Math.round(overallAvgSpeedLog.reduce((a,b) => a+b,0) / overallAvgSpeedLog.length);
  statsElements.avg.textContent = `${finalOverallAverageSpeed} 타/분`;

  statsElements.max.textContent = `${sessionResetInProgress ? 0 : overallMaxSpeed} 타/분`;
}

function updateProgressBar() {
    if (progressBarEl && progressBarContainerEl && linesToPractice.length > 0 && currentMode.includes('Long')) {
        const progress = linesToPractice.length > 1 ? (currentDisplayLineIndex / linesToPractice.length) * 100 : (currentDisplayLineIndex >= 1 ? 100 : 0);
        progressBarEl.style.width = `${Math.min(progress, 100)}%`;
    } else if (progressBarEl) progressBarEl.style.width = '0%';
}

function playTypingSound() {
  if (!soundEnabled || !currentSoundPack || !soundFiles[currentSoundPack] || !audioPool[currentSoundPack]) return;
  const soundPackSounds = soundFiles[currentSoundPack];
  const currentAudioPoolForPack = audioPool[currentSoundPack];
  if (soundPackSounds.length === 0 || currentAudioPoolForPack.length === 0) return;

  const soundSrc = getRandom(soundPackSounds);
  if (!soundSrc) return;

  if (audioPointer[currentSoundPack] === undefined || audioPointer[currentSoundPack] === null || audioPointer[currentSoundPack] >= currentAudioPoolForPack.length) audioPointer[currentSoundPack] = 0;

  let audioToPlay = currentAudioPoolForPack[audioPointer[currentSoundPack]];
  audioPointer[currentSoundPack] = (audioPointer[currentSoundPack] + 1) % currentAudioPoolForPack.length;

  if (audioToPlay && !audioToPlay.paused) { audioToPlay.pause(); audioToPlay.currentTime = 0; }
  if (audioToPlay) {
    audioToPlay.src = soundSrc;
    const playPromise = audioToPlay.play();
    if (playPromise !== undefined) playPromise.catch(error => { /* console.warn("오디오 재생 시도 실패:", error); */ });
  } else initializeAudioPoolForPack(currentSoundPack);
}

function activateGameMode() {
    isGameActive = false;
    currentMode = 'game';
    document.body.classList.add('game-mode-active');

    if (gameLoopId) cancelAnimationFrame(gameLoopId);
    if (wordGenerationIntervalId) clearInterval(wordGenerationIntervalId);
    isTimeStopped = false;

    gameAreaContainerEl.innerHTML = `
        <div id="gameInternalControlsBar">
            <div class="game-control-row" id="gameControlsRow1"></div>
            <div class="game-control-row" id="gameControlsRow2"></div>
            <div class="game-control-row" id="gameControlsRow3"></div>
        </div>
        <div class="game-ui-wrapper">
            <div id="game-start-message" style="display: flex; flex-direction: column; align-items: center;">
                 <h2><i class="fas fa-gamepad"></i> 단어 게임</h2>
                 <p>떨어지는 단어를 빠르게 입력하세요!<br>레벨을 선택하고 게임 시작 버튼을 눌러주세요.<br>각 레벨은 2분 동안 진행됩니다. 특수 아이템을 노려보세요!</p>
                 <button id="startGameFromCanvasBtn" class="game-button"><i class="fas fa-play"></i> 게임 시작</button>
            </div>
            <canvas id="game-canvas"></canvas>
            <input type="text" id="game-input-field" autocorrect="off" autocapitalize="off" spellcheck="false" autocomplete="off" placeholder="단어 입력 후 Enter">
        </div>
        <div id="gameOverlay" class="game-overlay"></div>
    `;
    gameAreaContainerEl.style.display = 'flex';
    gameStartMessageEl = document.getElementById('game-start-message');


    const gameInternalControlsBar = document.getElementById('gameInternalControlsBar');
    const row1 = document.getElementById('gameControlsRow1');
    const row2 = document.getElementById('gameControlsRow2');
    const row3 = document.getElementById('gameControlsRow3');


    const levelSelectLabel = document.createElement('label');
    levelSelectLabel.htmlFor = 'gameLevelSelect';
    levelSelectLabel.classList.add('select-label');
    levelSelectLabel.textContent = '레벨:';
    row1.appendChild(levelSelectLabel);

    const gameLevelSelect = document.createElement('select');
    gameLevelSelect.id = 'gameLevelSelect';
    for (let i = 0; i < gameLevelsConfig.length; i++) {
        const option = document.createElement('option');
        option.value = i + 1;
        option.textContent = `${i + 1}`;
        gameLevelSelect.appendChild(option);
    }
    gameLevelSelect.value = gameLevel;
    gameLevelSelect.addEventListener('change', (e) => {
        gameLevel = parseInt(e.target.value);
        if (isGameActive) initGame(false);
    });
    row1.appendChild(gameLevelSelect);

    const langSelectLabel = document.createElement('label');
    langSelectLabel.htmlFor = 'gameLangSelect';
    langSelectLabel.classList.add('select-label');
    langSelectLabel.textContent = '언어:';
    row1.appendChild(langSelectLabel);

    const gameLangSelect = document.createElement('select');
    gameLangSelect.id = 'gameLangSelect';
    const korOption = document.createElement('option');
    korOption.value = 'kor'; korOption.textContent = '한국어';
    const engOption = document.createElement('option');
    engOption.value = 'eng'; engOption.textContent = '영어';
    gameLangSelect.appendChild(korOption);
    gameLangSelect.appendChild(engOption);
    gameLangSelect.value = preferredGameLanguage;
    gameLangSelect.addEventListener('change', (e) => {
        preferredGameLanguage = e.target.value;
        if (isGameActive) initGame(false);
    });
    row1.appendChild(gameLangSelect);

    gameToggleSoundBtn = document.createElement('button');
    gameToggleSoundBtn.id = 'gameToggleSoundBtn';
    gameToggleSoundBtn.classList.toggle('active', soundEnabled);
    gameToggleSoundBtn.innerHTML = soundEnabled ? '<i class="fas fa-volume-up"></i> 타건음 ON' : '<i class="fas fa-volume-mute"></i> 타건음 OFF';
    gameToggleSoundBtn.addEventListener('click', () => {
        soundEnabled = !soundEnabled;
        gameToggleSoundBtn.classList.toggle('active', soundEnabled);
        gameToggleSoundBtn.innerHTML = soundEnabled ? '<i class="fas fa-volume-up"></i> 타건음 ON' : '<i class="fas fa-volume-mute"></i> 타건음 OFF';
        if(toggleSoundBtn) {
            toggleSoundBtn.classList.toggle('active', soundEnabled);
            toggleSoundBtn.innerHTML = soundEnabled ? '<i class="fas fa-volume-up"></i> 타건음 ON' : '<i class="fas fa-volume-mute"></i> 타건음 OFF';
        }
    });
    row1.appendChild(gameToggleSoundBtn);


    row2.appendChild(soundSettingsEl);
    row2.appendChild(themeSettingsEl);


    const returnBtn = document.createElement('button');
    returnBtn.id = 'returnToPracticeBtnGame';
    returnBtn.classList.add('game-button');
    returnBtn.innerHTML = `<i class="fas fa-keyboard"></i> 타자연습 하러가기`;
    returnBtn.addEventListener('click', () => returnToPracticeMode(true));
    row3.appendChild(returnBtn);


    gameCanvas = document.getElementById('game-canvas');
    gameCtx = gameCanvas.getContext('2d');
    gameInputField = document.getElementById('game-input-field');
    gameOverlayEl = document.getElementById('gameOverlay');

    const containerWidth = gameAreaContainerEl.querySelector('.game-ui-wrapper').clientWidth;
    gameCanvas.width = Math.min(containerWidth > 0 ? containerWidth : 600, 800);
    gameCanvas.height = Math.max(window.innerHeight * 0.65, 400);


    document.querySelectorAll('.practice-mode-controls button').forEach(btn => btn.classList.remove('active'));
    if (gameModeBtnEl) gameModeBtnEl.classList.add('active');

    document.getElementById('startGameFromCanvasBtn').addEventListener('click', () => {
        initGame(true);
    });
    drawGame();
}


function showGameOverlayMessage(type, score = 0, level = 1) {
    gamePausedForOverlay = true;
    let content = '';
    switch(type) {
        case "gameOver":
            content = `
                <h2><i class="fas fa-skull-crossbones"></i> 게임 오버</h2>
                <p>최종 점수: ${score}<br>달성 레벨: ${level}</p>
                <button id="playAgainBtnOverlay" class="game-button"><i class="fas fa-redo"></i> 다시 시작</button>
                <button id="returnToPracticeOverlayBtn" class="game-button" style="background: var(--text-secondary); border-color: var(--text-secondary);"><i class="fas fa-keyboard"></i> 타자연습 하러가기</button>
            `;
            break;
        case "levelUp":
            gameOverlayEl.innerHTML = `<h2>레벨 ${level} 달성!</h2>`;
            gameOverlayEl.classList.add('visible');
            setTimeout(() => {
                gameOverlayEl.classList.remove('visible');
                gamePausedForOverlay = false;
            }, 1500);
            return;
    }
    if (type !== "levelUp") {
        gameOverlayEl.innerHTML = content;
        gameOverlayEl.classList.add('visible');
    }

    if (type === "gameOver") {
        document.getElementById('playAgainBtnOverlay').addEventListener('click', () => {
            gameOverlayEl.classList.remove('visible');
            gamePausedForOverlay = false;
            initGame(true);
        });
        document.getElementById('returnToPracticeOverlayBtn').addEventListener('click', () => returnToPracticeMode(true));
    }
}


function initGame(fromStartButton = false) {
    if (gameStartMessageEl && fromStartButton) {
        gameStartMessageEl.style.display = 'none';
    }
    isGameActive = true;
    gamePausedForOverlay = false;
    levelStartTime = Date.now();

    const gameLevelSelectInBar = document.getElementById('gameLevelSelect');
    if (gameLevelSelectInBar) gameLevel = parseInt(gameLevelSelectInBar.value);

    const gameLangSelectInBar = document.getElementById('gameLangSelect');
    if (gameLangSelectInBar) preferredGameLanguage = gameLangSelectInBar.value;

    gameScore = 0;
    gameLives = INITIAL_LIVES;
    wordsOnScreen = [];
    isTimeStopped = false;

    if(gameInputField) {
      gameInputField.disabled = false;
      gameInputField.value = '';
      setTimeout(() => gameInputField.focus(), 100);

      if (!gameInputField.gameInputListenerAdded_input) {
          gameInputField.addEventListener('input', () => {
              if (isGameActive && !gamePausedForOverlay) {
                  playTypingSound();
              }
          });
          gameInputField.gameInputListenerAdded_input = true;
      }
      if (!gameInputField.gameInputListenerAdded_keydown) { // 엔터키 핸들러는 한 번만 등록
          gameInputField.addEventListener('keydown', handleGameInput);
          gameInputField.gameInputListenerAdded_keydown = true;
      }
    }

    startGameLoop();
    startWordGeneration();
}

function startGameLoop() {
    if (gameLoopId) cancelAnimationFrame(gameLoopId);
    function loop() {
        if (!isGameActive && !gamePausedForOverlay) {
             if(gameOverlayEl && !gameOverlayEl.classList.contains('visible') && gameStartMessageEl && gameStartMessageEl.style.display !== 'flex'){
                 cancelAnimationFrame(gameLoopId);
                 return;
             }
        }
        if (isGameActive && !gamePausedForOverlay) {
            updateGameLogic();
        }
        drawGame();
        if (isGameActive || gamePausedForOverlay || (gameStartMessageEl && gameStartMessageEl.style.display === 'flex')) {
             gameLoopId = requestAnimationFrame(loop);
        }
    }
    gameLoopId = requestAnimationFrame(loop);
}

function startWordGeneration() {
    if (wordGenerationIntervalId) clearInterval(wordGenerationIntervalId);
    const currentLevelIndex = Math.max(0, Math.min(gameLevel - 1, gameLevelsConfig.length - 1));
    const currentLevelConfig = gameLevelsConfig[currentLevelIndex];
    generateGameWord();
    wordGenerationIntervalId = setInterval(() => {
        if (!isTimeStopped) {
            generateGameWord();
        }
    }, currentLevelConfig.genRate);
}

function generateGameWord() {
    if (!isGameActive || !gameCanvas || gamePausedForOverlay || isTimeStopped) return;
    const currentLevelIndex = Math.max(0, Math.min(gameLevel - 1, gameLevelsConfig.length - 1));
    const currentLevelConfig = gameLevelsConfig[currentLevelIndex];
    const wordPool = preferredGameLanguage === 'kor' ? gameWordsKor : gameWordsEng;
    const MAX_DUPLICATE_CHECK_ATTEMPTS = 10;

    let newWordText;
    let attempts = 0;
    let isDuplicate;
    let itemTypeDetails = null;

    let minLen = currentLevelConfig.wordMinLenDefault;
    let maxLen = currentLevelConfig.wordMaxLenDefault;

    // 레벨에 따라 단어 길이 범위 동적 조정 (좀 더 세분화)
    if (gameLevel >= 3 && gameLevel <= 5) { minLen = Math.max(minLen, 2); maxLen = Math.min(maxLen +1, 4); }
    else if (gameLevel >= 6 && gameLevel <= 8) { minLen = Math.max(minLen, 3); maxLen = Math.min(maxLen +1, 5); }
    else if (gameLevel >= 9 && gameLevel <= 11) { minLen = Math.max(minLen, 3); maxLen = Math.min(maxLen + 2, 6); }
    else if (gameLevel >= 12 && gameLevel <= 14) { minLen = Math.max(minLen, 4); maxLen = Math.min(maxLen + 2, 8); }
    else if (gameLevel >= 15) { minLen = Math.max(minLen, 5); maxLen = Math.min(maxLen + 3, 10); }


    if (Math.random() < ITEM_SPAWN_PROBABILITY) {
        const itemKeys = Object.keys(ITEM_TYPES);
        const randomItemKey = itemKeys[Math.floor(Math.random() * itemKeys.length)];
        itemTypeDetails = ITEM_TYPES[randomItemKey];
    }

    do {
        newWordText = getRandom(wordPool);
        if (!newWordText) { attempts = MAX_DUPLICATE_CHECK_ATTEMPTS + 1; continue; }

        if (itemTypeDetails && attempts < 1) {
            isDuplicate = wordsOnScreen.some(word => word.text === newWordText && word.itemType === itemTypeDetails.type);
        } else {
            isDuplicate = wordsOnScreen.some(word => word.text === newWordText && !word.itemType);
        }
        attempts++;
        if (attempts > MAX_DUPLICATE_CHECK_ATTEMPTS && isDuplicate && !itemTypeDetails) { break; }
    } while (
        (!newWordText || newWordText.length < minLen || newWordText.length > maxLen || (isDuplicate && !itemTypeDetails) ) &&
        attempts <= MAX_DUPLICATE_CHECK_ATTEMPTS
    );

    if (!newWordText) newWordText = preferredGameLanguage === 'kor' ? "단어" : "word";

    gameCtx.font = GAME_FONT;
    const displayText = itemTypeDetails ? itemTypeDetails.textPrefix + newWordText : newWordText;
    const wordWidth = gameCtx.measureText(displayText).width;

    let fallSpeed = currentLevelConfig.fallSpeed;
    if (Math.random() < currentLevelConfig.fastWordChance) {
        fallSpeed *= currentLevelConfig.fastWordMultiplier;
    }
    fallSpeed += (Math.random() * 0.05 - 0.025); // 불규칙성 약간 줄임


    const wordObj = {
        text: newWordText,
        displayText: displayText,
        x: Math.random() * (gameCanvas.width - wordWidth - 20) + 10,
        y: 45,
        speed: fallSpeed,
        color: itemTypeDetails ? itemTypeDetails.color : null,
        itemType: itemTypeDetails ? itemTypeDetails.type : null,
        itemDuration: itemTypeDetails ? itemTypeDetails.duration : null
    };
    wordsOnScreen.push(wordObj);
}

function updateGameLogic() {
    if (!isGameActive || !gameCanvas || gamePausedForOverlay || !levelStartTime) return;

    if (isTimeStopped) {
        const elapsedTimeSinceLevelStart = Date.now() - levelStartTime;
         if (elapsedTimeSinceLevelStart >= LEVEL_DURATION_MS && gameLives > 0) {
            if (gameLevel < gameLevelsConfig.length) {
                gameLevel++;
                const gameLevelSelectInBar = document.getElementById('gameLevelSelect');
                if (gameLevelSelectInBar) gameLevelSelectInBar.value = gameLevel;
                showGameOverlayMessage("levelUp", gameScore, gameLevel);
                levelStartTime = Date.now();
                isTimeStopped = false;
                if(window.timeStopTimeoutId) clearTimeout(window.timeStopTimeoutId);
            } else {
                gameOver("maxLevelReached"); return;
            }
        }
        return;
    }


    const elapsedTime = Date.now() - levelStartTime;
    if (elapsedTime >= LEVEL_DURATION_MS && gameLives > 0) {
        if (gameLevel < gameLevelsConfig.length) {
            gameLevel++;
            const gameLevelSelectInBar = document.getElementById('gameLevelSelect');
            if (gameLevelSelectInBar) gameLevelSelectInBar.value = gameLevel;
            showGameOverlayMessage("levelUp", gameScore, gameLevel);
            levelStartTime = Date.now();
        } else {
            gameOver("maxLevelReached"); return;
        }
    }

    for (let i = wordsOnScreen.length - 1; i >= 0; i--) {
        wordsOnScreen[i].y += wordsOnScreen[i].speed;
        if (wordsOnScreen[i].y > gameCanvas.height + parseInt(GAME_FONT)) {
            wordsOnScreen.splice(i, 1);
            if (gameLives > 0) {
                gameLives--;
                triggerLifeLostEffect();
                if (gameLives <= 0) {
                    gameOver("lives"); return;
                }
            }
        }
    }
}

function triggerLifeLostEffect() {
    if (gameCanvas) {
        gameCanvas.classList.add('flash-effect');
        setTimeout(() => {
            if(gameCanvas) gameCanvas.classList.remove('flash-effect');
        }, 300);
    }
}


function drawGame() {
    if (!gameCtx || !gameCanvas) return;
    gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

    if (!isGameActive && gameStartMessageEl && gameStartMessageEl.style.display === 'flex') {
        return;
    }

    let defaultGameWordColor;
    if (document.body.classList.contains('light-theme')) {
        defaultGameWordColor = '#3a322d';
    } else if (document.body.classList.contains('pink-theme')) {
        defaultGameWordColor = '#78283e';
    } else {
        defaultGameWordColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
    }
    gameCtx.font = GAME_FONT;


    for (const word of wordsOnScreen) {
        gameCtx.fillStyle = word.color || defaultGameWordColor;
        gameCtx.fillText(word.displayText, word.x, word.y);
    }

    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim();
    const topUiY = 20;
    const timerBarY = 30;
    const timerBarHeight = 8;
    const timerBarWidth = gameCanvas.width * 0.6;
    const timerBarX = (gameCanvas.width - timerBarWidth) / 2;

    gameCtx.fillStyle = accentColor;
    gameCtx.font = "bold 14px " + getComputedStyle(document.documentElement).getPropertyValue('--font-ui').trim();

    gameCtx.textAlign = "left";
    gameCtx.fillText(`점수: ${gameScore}`, 10, topUiY);

    gameCtx.textAlign = "center";
    gameCtx.fillText(`레벨: ${gameLevel}`, gameCanvas.width / 2, topUiY);

    gameCtx.textAlign = "right";
    let livesDisplay = "";
    for(let i=0; i<INITIAL_LIVES; i++) {
        livesDisplay += (i < gameLives ? "❤️" : "🖤");
    }
    gameCtx.fillText(`생명: ${livesDisplay}`, gameCanvas.width - 10, topUiY);


    if (isGameActive && levelStartTime) {
        const currentElapsedTime = Date.now() - levelStartTime;
        const remainingTimeMs = Math.max(0, LEVEL_DURATION_MS - currentElapsedTime);
        const totalSeconds = Math.floor(remainingTimeMs / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        gameCtx.textAlign = "center";
        gameCtx.fillStyle = defaultGameWordColor;
        gameCtx.fillText(timeString, gameCanvas.width / 2, timerBarY + timerBarHeight + 12);

        gameCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--input-border').trim();
        gameCtx.fillRect(timerBarX, timerBarY, timerBarWidth, timerBarHeight);

        const progressWidth = (remainingTimeMs / LEVEL_DURATION_MS) * timerBarWidth;
        gameCtx.fillStyle = accentColor;
        gameCtx.fillRect(timerBarX, timerBarY, progressWidth, timerBarHeight);
    }
     gameCtx.textAlign = "left";
}

function handleGameInput(e) {
    if (e.type === 'keydown' && e.key === 'Enter') {
        e.preventDefault();
        if (!isGameActive || gamePausedForOverlay) return;

        const typedWord = gameInputField.value.trim();
        if (typedWord === "") return;

        const sortedWordsOnScreen = [...wordsOnScreen].sort((a, b) => b.y - a.y);

        let foundMatch = false;
        for (let i = 0; i < sortedWordsOnScreen.length; i++) {
            const wordObj = sortedWordsOnScreen[i];
            if (wordObj.text.toLowerCase() === typedWord.toLowerCase()) {
                gameScore += wordObj.text.length * (preferredGameLanguage === 'kor' ? 5 : 10);

                const originalIndex = wordsOnScreen.findIndex(w => w === wordObj);
                if (originalIndex > -1) {
                    wordsOnScreen.splice(originalIndex, 1);
                }

                foundMatch = true;
                playTypingSound(); // 엔터로 단어 맞출 때 타건음

                if (wordObj.itemType) {
                    activateItemEffect(wordObj.itemType, wordObj.itemDuration);
                }
                break;
            }
        }

        if (!foundMatch) {
            gameAreaContainerEl.classList.add('shake-effect');
            setTimeout(() => gameAreaContainerEl.classList.remove('shake-effect'), 200);
        }
        gameInputField.value = "";
    }
}

function activateItemEffect(itemType, duration) {
    switch (itemType) {
        case ITEM_TYPES.TIME_STOP.type:
            isTimeStopped = true;
            if (window.timeStopTimeoutId) clearTimeout(window.timeStopTimeoutId);
            window.timeStopTimeoutId = setTimeout(() => {
                isTimeStopped = false;
            }, duration || 3000);
            break;
        case ITEM_TYPES.CLEAR_SCREEN.type:
            wordsOnScreen = wordsOnScreen.filter(word => word.itemType !== null);
            break;
        case ITEM_TYPES.EXTRA_LIFE.type:
            if (gameLives < INITIAL_LIVES) {
                gameLives++;
            }
            break;
    }
}

function gameOver(reason = "lives") {
    isGameActive = false;
    if (gameInputField) gameInputField.disabled = true;
    if (wordGenerationIntervalId) clearInterval(wordGenerationIntervalId);
    wordGenerationIntervalId = null;
    if (window.timeStopTimeoutId) clearTimeout(window.timeStopTimeoutId);
    isTimeStopped = false;

    let messageType = "gameOver";
    showGameOverlayMessage(messageType, gameScore, gameLevel);
}

function returnToPracticeMode(resetSessionStats = true) {
    isGameActive = false;
    gamePausedForOverlay = false;
    if (gameLoopId) cancelAnimationFrame(gameLoopId);
    if (wordGenerationIntervalId) clearInterval(wordGenerationIntervalId);
    gameLoopId = null; wordGenerationIntervalId = null;
    levelStartTime = null;
    isTimeStopped = false;
    if (window.timeStopTimeoutId) clearTimeout(window.timeStopTimeoutId);


    if (gameOverlayEl) gameOverlayEl.classList.remove('visible');
    if (gameStartMessageEl) gameStartMessageEl.style.display = 'none';
    document.body.classList.remove('game-mode-active');

    if (mainControlsEl && originalSoundParent && originalThemeParent) {
        const gameInternalControlsBar = document.getElementById('gameInternalControlsBar');
        if (gameInternalControlsBar && soundSettingsEl.parentNode === gameInternalControlsBar) {
            originalSoundParent.insertBefore(soundSettingsEl, originalSoundNextSibling);
        }
        if (gameInternalControlsBar && themeSettingsEl.parentNode === gameInternalControlsBar) {
            originalThemeParent.insertBefore(themeSettingsEl, originalThemeNextSibling);
        }
        if (gameToggleSoundBtn && gameToggleSoundBtn.parentNode) {
            gameToggleSoundBtn.parentNode.removeChild(gameToggleSoundBtn);
            gameToggleSoundBtn = null;
        }
    }

    const lastPracticeMode = Array.from(document.querySelectorAll('.practice-mode-controls button.active'))
                              .map(b => b.dataset.mode).find(m => m) || 'kor';
    startPractice(lastPracticeMode, resetSessionStats);
}
</script>
</body>
</html>
